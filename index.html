<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Puzzle Cache</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2em;
      background-color: #f4f4f4;
      color: #333;
    }
    .stage {
      display: none;
      background-color: #fff;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      margin: 2em auto;
    }
    .active {
      display: block;
    }
    button {
      padding: 0.8em 1.5em;
      margin-top: 1.5em;
      background-color: white; /* Changed to white */
      color: black;            /* Changed to black */
      border: 1px solid black; /* Added black border */
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; /* Added border-color transition */
    }
    button:hover {
      background-color: #e0e0e0; /* Lighter grey on hover for white buttons */
      border-color: #555; /* Slightly darker border on hover */
    }
    .retry-button {
      background-color: #f44336; /* Kept red for retry */
      color: white;
      border: 1px solid #f44336; /* Solid red border */
    }
    .retry-button:hover {
      background-color: #da190b; /* Darker red on hover */
      border-color: #da190b;
    }


    canvas {
      border: 1px solid #ccc;
      margin-top: 1em;
      background-color: #fff;
      pointer-events: auto;
    }
    canvas.disabled {
      pointer-events: none;
      opacity: 0.7;
      cursor: not-allowed;
    }

    input[type="text"], input[type="number"], input[type="password"] {
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: calc(100% - 1em);
      max-width: 300px;
    }

    /* Trivia Specific Styles */
    #triviaForm {
      text-align: left;
      max-width: 700px;
      margin: 0 auto;
    }
    .trivia-question {
      margin-bottom: 2em;
      padding: 1.5em;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fdfdfd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .trivia-question p {
      margin-top: 0;
      margin-bottom: 1em;
      font-weight: bold;
      font-size: 1.1em;
    }
    .trivia-question label {
      display: flex;
      align-items: center;
      margin-bottom: 0.8em;
      cursor: pointer;
      padding: 0.5em 0.8em;
      border: 1px solid transparent;
      border-radius: 5px;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      font-size: 1.05em;
    }
    .trivia-question label input[type="radio"] {
      /* Adjusted styles for radio buttons */
      width: 1.5em;
      height: 1.5em;
      margin-right: 1em;
      flex-shrink: 0;
      /* Ensure default browser radio button rendering */
      -webkit-appearance: radio; /* For Safari/Chrome */
      -moz-appearance: radio;    /* For Firefox */
      appearance: radio;         /* Standard */
    }
    .trivia-question input[type="radio"]:checked + label {
      background-color: #d4edda;
      border-color: #28a745;
      color: #155724;
      font-weight: bold;
    }

    #triviaResult {
      margin-top: 1.5em;
      font-weight: bold;
    }

    /* Standardized button for starting online puzzle */
    .start-online-puzzle-button {
        display: inline-block;
        background-color: #007bff; /* A nice blue color */
        color: white;
        padding: 12px 24px; /* Adjust padding for size */
        text-align: center;
        text-decoration: none; /* Removes the underline default for links */
        font-size: 1.1em; /* Font size */
        font-weight: bold; /* Make text bolder */
        border-radius: 8px; /* Rounded corners */
        /* Optional: Add a simple hover effect using a filter for compatibility */
        filter: brightness(90%); /* Slightly darker on hover (some platforms might strip :hover CSS) */
        transition: background-color 0.3s ease;
    }
    .start-online-puzzle-button:hover {
        background-color: #0056b3; /* Darker blue on hover */
        filter: none; /* Reset filter on hover if used for a proper hover */
    }

  </style>
</head>
<body>
  <div id="startStage" class="stage active">
    <h2>Welcome to the Puzzle Cache Adventure!</h2>
    <p>Enter your nickname to begin your challenge.</p>
    <input type="text" id="nicknameInput" placeholder="Enter your nickname" maxlength="20">
    <button onclick="startAdventure()">Start Adventure</button>
    <p id="nicknameError" style="color:red; display:none; margin-top: 1em;">Please enter a nickname to start.</p>
  </div>

  <div id="stage1" class="stage">
    <h2>Stage 1: Beat the AI at Tic Tac Toe</h2>
    <p>Play on the 3x3 square grid.</p>
    <canvas id="ttt" width="300" height="300"></canvas>
    <p id="tttMessage"></p>
    <button id="tttNext" style="display:none" onclick="showStage(2)">Next Puzzle</button>
    <button id="tttRetry" class="retry-button" style="display:none" onclick="resetTtt()">Try Again</button>
  </div>

  <div id="stage2" class="stage">
    <h2>Stage 2: Geocaching Trivia</h2>
    <form id="triviaForm">
      <div class="trivia-question">
        <p>1. The first geocache was placed in Oregon. What was the exact date it was hidden?</p>
        <input type="radio" id="q1a1" name="q1" value="May 3, 2000"><label for="q1a1">May 3, 2000</label><br>
        <input type="radio" id="q1a2" name="q1" value="May 2, 2000"><label for="q1a2">May 2, 2000</label><br>
        <input type="radio" id="q1a3" name="q1" value="May 1, 2000"><label for="q1a3">May 1, 2000</label><br>
        <input type="radio" id="q1a4" name="q1" value="April 30, 2000"><label for="q1a4">April 30, 2000</label>
      </div>

      <div class="trivia-question">
        <p>2. In the geocaching community, what is the term for an accidental find where a cache is stumbled upon by a non-geocacher?</p>
        <input type="radio" id="q2a1" name="q2" value="Muggle"><label for="q2a1">Muggle</label><br>
        <input type="radio" id="q2a2" name="q2" value="Blunder"><label for="q2a2">Blunder</label><br>
        <input type="radio" id="q2a3" name="q2" value="Stumble"><label for="q2a3">Stumble</label><br>
        <input type="radio" id="q2a4" name="q2" value="Accidental Discovery"><label for="q2a4">Accidental Discovery</label>
      </div>

      <div class="trivia-question">
        <p>3. What do the initials "CITO" stand for in the geocaching community?</p>
        <input type="radio" id="q3a1" name="q3" value="Cache In, Take Out"><label for="q3a1">Cache In, Take Out</label><br>
        <input type="radio" id="q3a2" name="q3" value="Cleaning Is The Objective"><label for="q3a2">Cleaning Is The Objective</label><br>
        <input type="radio" id="q3a3" name="q3" value="Conservation In, Trash Out"><label for="q3a3">Conservation In, Trash Out</label><br>
        <input type="radio" id="q3a4" name="q3" value="Cache In, Trash Out"><label for="q3a4">Cache In, Trash Out</label>
      </div>

      <div class="trivia-question">
        <p>4. Which of these geocache types typically does NOT contain a physical logbook?</p>
        <input type="radio" id="q4a1" name="q4" value="Traditional"><label for="q4a1">Traditional</label><br>
        <input type="radio" id="q4a2" name="q4" value="Mystery/Puzzle"><label for="q4a2">Mystery/Puzzle</label><br>
        <input type="radio" id="q4a3" name="q4" value="Multi-Cache"><label for="q4a3">Multi-Cache</label><br>
        <input type="radio" id="q4a4" name="q4" value="EarthCache"><label for="q4a4">EarthCache</label>
      </div>

      <div class="trivia-question">
        <p>5. What is the maximum "difficulty" rating a geocache can have?</p>
        <input type="radio" id="q5a1" name="q5" value="4.5 stars"><label for="q5a1">4.5 stars</label><br>
        <input type="radio" id="q5a2" name="q5" value="5 stars"><label for="q5a2">5 stars</label><br>
        <input type="radio" id="q5a3" name="q5" value="6 stars"><label for="q5a3">6 stars</label><br>
        <input type="radio" id="q5a4" name="q5" value="10 stars"><label for="q5a4">10 stars</label>
      </div>

      <div class="trivia-question">
        <p>6. What specific event led to the initial widespread availability of accurate GPS for civilian use, enabling geocaching?</p>
        <input type="radio" id="q6a1" name="q6" value="Discontinuation of Selective Availability"><label for="q6a1">Discontinuation of Selective Availability</label><br>
        <input type="radio" id="q6a2" name="q6" value="Launch of the first GPS satellite"><label for="q6a2">Launch of the first GPS satellite</label><br>
        <input type="radio" id="q6a3" name="q6" value="Invention of the handheld GPS device"><label for="q6a3">Invention of the handheld GPS device</label><br>
        <input type="radio" id="q6a4" name="q6" value="Release of free mapping software"><label for="q6a4">Release of free mapping software</label>
      </div>

      <div class="trivia-question">
        <p>7. What is a defining characteristic of a "nano" geocache, typically due to its extremely small size?</p>
        <input type="radio" id="q7a1" name="q7" value="It always has a magnetic base."><label for="q7a1">It always has a magnetic base.</label><br>
        <input type="radio" id="q7a2" name="q7" value="It contains small trade items."><label for="q7a2">It contains small trade items.</label><br>
        <input type="radio" id="q7a3" name="q7" value="It only contains a rolled-up paper log."><label for="q7a3">It only contains a rolled-up paper log.</label><br>
        <input type="radio" id="q7a4" name="q7" value="It is hidden underwater."><label for="q7a4">It is hidden underwater.</label>
      </div>

      <div class="trivia-question">
        <p>8. What is the primary purpose of a "geocoin" or "Travel Bug"?</p>
        <input type="radio" id="q8a1" name="q8" value="To be collected and kept by finders"><label for="q8a1">To be collected and kept by finders</label><br>
        <input type="radio" id="q8a2" name="q8" value="To be moved from cache to cache, tracking its journey"><label for="q8a2">To be moved from cache to cache, tracking its journey</label><br>
        <input type="radio" id="q8a3" name="q8" value="As a prize for the First To Find (FTF)"><label for="q8a3">As a prize for the First To Find (FTF)</label><br>
        <input type="radio" id="q8a4" name="q8" value="To mark a DNF (Did Not-Find) location"><label for="q8a4">To mark a DNF (Did Not-Find) location</label>
      </div>

      <div class="trivia-question">
        <p>9. What is a "Project APE" cache?</p>
        <input type="radio" id="q9a1" name="q9" value="A cache hidden in conjunction with a scientific research project"><label for="q9a1">A cache hidden in conjunction with a scientific research project</label><br>
        <input type="radio" id="q9a2" name="q9" value="A highly camouflaged cache that is difficult to spot"><label for="q9a2">A highly camouflaged cache that is difficult to spot</label><br>
        <input type="radio" id="q9a3" name="q9" value="A special cache series hidden to promote the movie 'Planet of the Apes'"><label for="q9a3">A special cache series hidden to promote the movie 'Planet of the Apes'</label><br>
        <input type="radio" id="q9a4" name="q9" value="A cache associated with an educational or conservation initiative"><label for="q9a4">A cache associated with an educational or conservation initiative</label>
      </div>

      <div class="trivia-question">
        <p>10. What is the minimum recommended distance between two physical geocaches (in meters, approximately)?</p>
        <input type="radio" id="q10a1" name="q10" value="25 meters"><label for="q10a1">25 meters</label><br>
        <input type="radio" id="q10a2" name="q10" value="50 meters"><label for="q10a2">50 meters</label><br>
        <input type="radio" id="q10a3" name="q10" value="161 meters"><label for="q10a3">161 meters</label><br>
        <input type="radio" id="q10a4" name="q10" value="200 meters"><label for="q10a4">200 meters</label>
      </div>

      <button type="button" onclick="checkTrivia()">Submit Answers</button>
    </form>
    <p id="triviaResult"></p>
    <button id="triviaNext" style="display:none" onclick="showStage(3)">Next Puzzle</button>
  </div>

  <div id="stage3" class="stage">
    <h2>Stage 3: Decode the Cipher</h2>
    <p>For the code `Jhfdfdkklqj25`:</p>
    <p>Keep the numbers exactly as they are.</p>
    <p>Shift the letters three places down the alphabet (e.g., 'D' becomes 'A', 'E' becomes 'B', 'C' becomes 'Z').</p>
    <input id="cipherInput" placeholder="Your answer" />
    <button onclick="checkCipher()">Check</button>
    <p id="cipherResult"></p>
    <button id="cipherNext" style="display:none" onclick="showStage(4)">Next Puzzle</button>
  </div>

  <div id="stage4" class="stage">
    <h2>Stage 4: Guess the Number (1–100)</h2>
    <input id="guessInput" type="number" min="1" max="100" />
    <button onclick="checkGuess()">Guess</button>
    <p id="guessResult"></p>
    <button id="guessNext" style="display:none" onclick="showStage('final')">Next Puzzle</button>
  </div>

  <div id="final" class="stage">
    <h2>🎉 Congratulations!</h2>
    <p>You've solved all the puzzles! Here are your final coordinates:</p>
    <p><strong>Coordinates:</strong> <span id="finalCoords">N 51 29.915 W 000 06.317</span></p>
    <p><strong>Hint:</strong> <span id="finalHint">230 volts</span></p>
    <button onclick="copyCoordsHint()">Copy Coords/Hint</button>
<p>St. George's Circus, located in Southwark, London, is much more than just a busy roundabout; it holds the distinction of being London's first purpose-built traffic junction. Designed by John Gwynn and completed in 1771, it was an ambitious urban planning project intended to efficiently connect the newly built Blackfriars Bridge, as well as Westminster Bridge and London Bridge, with the growing road network south of the Thames. At its heart stands a striking obelisk, marking its central position and historical significance. Today, this bustling intersection continues its original function, serving as a vital transport hub and a testament to pioneering urban design, surrounded by educational institutions and a vibrant local community.</p>
  </div>

  <script>
    // Global variable for nickname
    let userNickname = "";

    function showStage(id) {
      document.querySelectorAll(".stage").forEach(el => el.classList.remove("active"));
      document.getElementById(typeof id === 'number' ? `stage${id}` : id).classList.add("active");
      
      // Initialize games when their stage is shown
      if (id === 1) { // Tic Tac Toe
        resetTtt();
      }
      // Removed typing challenge initialization as Stage 5 is gone
    }

    // --- Start Adventure ---
    function startAdventure() {
        const nicknameInput = document.getElementById("nicknameInput");
        const nicknameError = document.getElementById("nicknameError");
        userNickname = nicknameInput.value.trim();

        if (userNickname === "") {
            nicknameError.style.display = "block";
            return;
        }

        nicknameError.style.display = "none";
        showStage(1); // Move to the first puzzle stage
    }

    // --- Tic Tac Toe (Existing Code) ---
    const tttCanvas = document.getElementById("ttt");
    const tttCtx = tttCanvas.getContext("2d");
    const tttSize = 100;
    let tttBoard = Array(9).fill("");
    let tttGameOver = false;
    let tttPlayerTurnActive = true;

    function drawBoard() {
      tttCtx.clearRect(0, 0, 300, 300);
      tttCtx.lineWidth = 2;
      tttCtx.strokeStyle = '#333';

      tttCtx.strokeRect(0, 0, 300, 300);

      for (let i = 1; i <= 2; i++) {
        tttCtx.moveTo(i * tttSize, 0);
        tttCtx.lineTo(i * tttSize, 300);
        tttCtx.moveTo(0, i * tttSize);
        tttCtx.lineTo(300, i * tttSize);
      }
      tttCtx.stroke();

      tttBoard.forEach((val, i) => {
        if (val) {
          const x = (i % 3) * tttSize + tttSize / 2;
          const y = Math.floor(i / 3) * tttSize + tttSize / 2;
          tttCtx.font = "48px sans-serif";
          tttCtx.textAlign = "center";
          tttCtx.textBaseline = "middle";
          tttCtx.fillStyle = (val === 'X') ? '#007bff' : '#dc3545';
          tttCtx.fillText(val, x, y);
        }
      });
    }

    function checkWin(player, currentBoard = tttBoard) {
      const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      return lines.some(([a,b,c]) => currentBoard[a] === player && currentBoard[b] === player && currentBoard[c] === player);
    }

    function getEmptySquares(currentBoard = tttBoard) {
        return currentBoard.map((val, i) => val === "" ? i : null).filter(i => i !== null);
    }

    // Simpler AI Logic - Easier to Beat
    function tttAiMove() {
        const aiPlayer = "O";
        const huPlayer = "X";
        const emptySquares = getEmptySquares(tttBoard);

        if (emptySquares.length === 0) return -1; // No moves left

        // Helper to pick a random available square
        const pickRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];

        // 1. Try to win (highest priority)
        for (let i = 0; i < emptySquares.length; i++) {
            let tempBoard = [...tttBoard];
            tempBoard[emptySquares[i]] = aiPlayer;
            if (checkWin(aiPlayer, tempBoard)) {
                return emptySquares[i];
            }
        }

        // 2. Try to block human (next highest priority)
        for (let i = 0; i < emptySquares.length; i++) {
            let tempBoard = [...tttBoard];
            tempBoard[emptySquares[i]] = huPlayer;
            if (checkWin(huPlayer, tempBoard)) {
                return emptySquares[i];
            }
        }

        // 3. Otherwise, just pick a random available square
        return pickRandom(emptySquares);
    }

    function tttAiMakeMove() {
        if (tttGameOver) return;

        const moveIndex = tttAiMove();
        if (moveIndex !== -1) {
            tttBoard[moveIndex] = "O";
            drawBoard();

            if (checkWin("O")) {
                document.getElementById("tttMessage").textContent = "AI wins. Try again!";
                document.getElementById("tttMessage").style.color = "#e74c3c";
                tttGameOver = true;
                document.getElementById("tttNext").style.display = "none";
                document.getElementById("tttRetry").style.display = "inline";
                tttCanvas.classList.add('disabled');
            } else if (getEmptySquares().length === 0) {
                document.getElementById("tttMessage").textContent = "It's a draw!";
                document.getElementById("tttMessage").style.color = "#e67e22";
                tttGameOver = true;
                document.getElementById("tttNext").style.display = "none";
                document.getElementById("tttRetry").style.display = "inline";
                tttCanvas.classList.add('disabled');
            } else {
                tttPlayerTurnActive = true;
                tttCanvas.classList.remove('disabled');
            }
        }
    }

    function resetTtt() {
        tttBoard = Array(9).fill("");
        tttGameOver = false;
        tttPlayerTurnActive = true;
        document.getElementById("tttMessage").textContent = "";
        document.getElementById("tttNext").style.display = "none";
        document.getElementById("tttRetry").style.display = "none";
        tttCanvas.classList.remove('disabled');
        drawBoard();
    }

    tttCanvas.addEventListener("click", e => {
      if (tttGameOver || !tttPlayerTurnActive) {
          return;
      }

      const x = Math.floor(e.offsetX / tttSize);
      const y = Math.floor(e.offsetY / tttSize);
      const idx = y * 3 + x;

      if (tttBoard[idx] === "") {
        tttBoard[idx] = "X";
        drawBoard();

        if (checkWin("X")) {
          document.getElementById("tttMessage").textContent = "You win!";
          document.getElementById("tttMessage").style.color = "#27ae60";
          tttGameOver = true;
          document.getElementById("tttNext").style.display = "inline";
          document.getElementById("tttNext").focus(); // Optional: focus next button
          document.getElementById("tttRetry").style.display = "none";
          tttCanvas.classList.add('disabled');
        } else if (getEmptySquares().length === 0) {
          document.getElementById("tttMessage").textContent = "It's a draw!";
          document.getElementById("tttMessage").style.color = "#e67e22";
          tttGameOver = true;
          document.getElementById("tttNext").style.display = "none";
          document.getElementById("tttRetry").style.display = "inline";
          tttCanvas.classList.add('disabled');
        } else {
          tttPlayerTurnActive = false;
          tttCanvas.classList.add('disabled');
          setTimeout(tttAiMakeMove, 500);
        }
      }
    });

    drawBoard();

    // --- Trivia check ---
    function checkTrivia() {
      const correctAnswers = {
        q1: "May 3, 2000",
        q2: "Muggle",
        q3: "Cache In, Trash Out",
        q4: "EarthCache",
        q5: "5 stars",
        q6: "Discontinuation of Selective Availability",
        q7: "It only contains a rolled-up paper log.",
        q8: "To be moved from cache to cache, tracking its journey",
        q9: "A special cache series hidden to promote the movie 'Planet of the Apes'",
        q10: "161 meters"
      };

      let allCorrect = true;
      // Loop through all 10 questions
      for (let i = 1; i <= 10; i++) {
        const qName = `q${i}`;
        const selected = document.querySelector(`input[name="${qName}"]:checked`);
        if (!selected || selected.value !== correctAnswers[qName]) {
          allCorrect = false;
          break;
        }
      }

      const triviaResultElement = document.getElementById("triviaResult");
      if (allCorrect) {
        triviaResultElement.textContent = "Correct! All answers are right.";
        triviaResultElement.style.color = "#27ae60";
        document.getElementById("triviaNext").style.display = "inline";
      } else {
        triviaResultElement.textContent = "Incorrect. Please review your answers and try again.";
        triviaResultElement.style.color = "#e74c3c";
      }
    }

    // --- Cipher check ---
    function checkCipher() {
      const input = document.getElementById("cipherInput").value.trim();
      const cipherResultElement = document.getElementById("cipherResult");
      if (input === "Geocaching25") {
        cipherResultElement.textContent = "Correct!";
        cipherResultElement.style.color = "#27ae60";
        document.getElementById("cipherNext").style.display = "inline";
      } else {
        cipherResultElement.textContent = "Try again.";
        cipherResultElement.style.color = "#e74c3c";
      }
    }

    // --- Number Guess ---
    let secretNumber = Math.floor(Math.random() * 100) + 1;
    function checkGuess() {
      const guess = parseInt(document.getElementById("guessInput").value);
      const result = document.getElementById("guessResult");
      if (isNaN(guess)) {
        result.textContent = "Enter a number!";
        result.style.color = "#e74c3c";
        return;
      }
      if (guess === secretNumber) {
        result.textContent = "Correct!";
        result.style.color = "#27ae60";
        document.getElementById("guessNext").style.display = "inline";
      } else {
        result.textContent = (guess < secretNumber) ? "Too low!" : "Too high!";
        result.style.color = "#e67e22";
      }
    }

    // --- Copy Coords/Hint Function ---
    async function copyCoordsHint() {
      const coords = document.getElementById("finalCoords").textContent;
      const hint = document.getElementById("finalHint").textContent;
      const textToCopy = `Coordinates: ${coords}\nHint: ${hint}`;

      try {
        // Use document.execCommand('copy') as navigator.clipboard.writeText() may not work due to iFrame restrictions
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        textarea.style.position = 'fixed'; // Prevent scrolling to bottom of page in some browsers
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert("Coordinates and Hint copied to clipboard!");
      } catch (err) {
        console.error('Failed to copy text: ', err);
        alert("Failed to copy. Please copy manually: \n" + textToCopy);
      }
    }

    // Initialize the first stage on page load
    document.addEventListener("DOMContentLoaded", () => {
        showStage('startStage');
    });
  </script>
</body>
</html>